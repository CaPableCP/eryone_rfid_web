<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€—æRFIDè¯»å†™</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: #333;
        }

        .status {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            display: none;
            /* é»˜è®¤éšè— */
        }

        #statusMessage {
            margin: 0;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .control-panel,
        .read-panel,
        .write-panel {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: calc(50% - 10px);
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #stopReadBtn {
            background-color: #dc3545;
        }

        #stopReadBtn:hover {
            background-color: #c82333;
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }

        #readResult {
            background-color: #f8f9fa;
            white-space: pre-wrap;
            /* ä¿ç•™æ¢è¡Œ */
            word-wrap: break-word;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }

        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin-bottom: 20px;
        }

        /* æ–°å¢ï¼šè§£æç»“æœæ ·å¼ */
        .parse-result {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }

        .parse-result h4 {
            margin-top: 0;
            color: #007bff;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .data-table th {
            background-color: #f2f2f2;
            width: 30%;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 3px;
            vertical-align: middle;
            margin-right: 8px;
        }

        .raw-data {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin-top: 15px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .raw-data-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #666;
        }

        /* æ–°å¢ï¼šè€—æä¿¡æ¯è¡¨å•æ ·å¼ */
        .material-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .color-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .color-picker-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .color-picker-label {
            font-size: 14px;
            color: #555;
        }

        .opacity-slider-container {
            flex: 1;
        }

        .opacity-slider {
            width: 100%;
            margin-top: 5px;
        }

        .opacity-value {
            font-size: 14px;
            color: #555;
            margin-top: 5px;
        }

        .generated-data {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }

        .generated-data h4 {
            margin-top: 0;
            color: #333;
        }

        #generatedFormat {
            font-family: monospace;
            font-size: 16px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 600px) {
            .material-form {
                grid-template-columns: 1fr;
            }

            .form-group.full-width {
                grid-column: span 1;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ“± æ‰‹æœºè€—æNFCè¯»å†™å·¥å…·</h1>

        <div class="warning">
            <strong>é‡è¦æç¤ºï¼š</strong>
            <ul>
                <li>æœ¬å·¥å…·ä»…èƒ½åœ¨ <strong>Android ç‰ˆ Chrome æµè§ˆå™¨</strong> ä¸­ä½¿ç”¨ã€‚</li>
                <li>è¯·ç¡®ä¿æ‰‹æœºNFCåŠŸèƒ½å·²æ‰“å¼€ã€‚</li>
                <li>å°†æ ‡ç­¾è´´è¿‘æ‰‹æœºNFCæ„Ÿåº”åŒºã€‚</li>
                <li><strong>iPhone (iOS) ç³»ç»Ÿä¸æ”¯æŒæ­¤åŠŸèƒ½ã€‚</strong></li>
            </ul>
        </div>

        <!-- çŠ¶æ€ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="statusBox" class="status">
            <p id="statusMessage"></p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h2>ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ä¸æˆæƒ</h2>
            <button id="checkNFCBtn">æ£€æŸ¥NFCæ”¯æŒä¸æƒé™</button>
            <p id="supportInfo">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb NFCã€‚</p>
        </div>

        <!-- è¯»å–é¢æ¿ -->
        <div class="read-panel">
            <h2>ç¬¬äºŒæ­¥ï¼šè¯»å–æ ‡ç­¾æ•°æ®</h2>
            <p>ç‚¹å‡»"å¼€å§‹è¯»å–"åå°†æ ‡ç­¾è´´è¿‘æ‰‹æœºã€‚</p>
            <button id="startReadBtn" disabled>å¼€å§‹è¯»å–</button>
            <button id="stopReadBtn" disabled>åœæ­¢è¯»å–</button>

            <h3>è¯»å–ç»“æœï¼š</h3>
            <div id="readResult" class="raw-data" placeholder="è¯»å–åˆ°çš„æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></div>

            <!-- è§£æç»“æœåŒºåŸŸ -->
            <div id="parseResult" class="parse-result" style="display: none;">
                <h4>ğŸ“Š æ•°æ®è§£æç»“æœ</h4>
                <table id="dataTable" class="data-table">
                    <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </table>
                <div class="raw-data-title">åŸå§‹æ•°æ®ï¼š</div>
                <div id="rawDataText" class="raw-data"></div>
            </div>
        </div>

        <!-- å†™å…¥é¢æ¿ -->
        <div class="write-panel">
            <h2>ç¬¬ä¸‰æ­¥ï¼šå†™å…¥è€—ææ•°æ®åˆ°æ ‡ç­¾</h2>
            <p>å¡«å†™ä»¥ä¸‹è€—æä¿¡æ¯ï¼Œç„¶åç‚¹å‡»"ç”Ÿæˆå¹¶å†™å…¥"æŒ‰é’®å†™å…¥æ ‡ç­¾ï¼š</p>

            <div class="material-form">
                <!-- ç¬¬ä¸€è¡Œ -->
                <div class="form-group">
                    <label for="manufacturer">å‚å•†ä¿¡æ¯ (10å­—ä»¥å†…):</label>
                    <input type="text" id="manufacturer" maxlength="10" placeholder="ä¾‹å¦‚: ERYONE">
                </div>

                <div class="form-group">
                    <label for="materialType">è€—æç±»å‹ (4å­—ä»¥å†…):</label>
                    <input type="text" id="materialType" maxlength="4" placeholder="ä¾‹å¦‚: PLA">
                </div>

                <!-- ç¬¬äºŒè¡Œ -->
                <div class="form-group">
                    <label for="subMaterial">å­è€—æ (4å­—ä»¥å†…ï¼Œå¯ä¸ºç©º):</label>
                    <input type="text" id="subMaterial" maxlength="4" placeholder="ä¾‹å¦‚: CF">
                </div>

                <div class="form-group">
                    <label>é¢œè‰²ä¸é€æ˜åº¦:</label>
                    <div class="color-section">
                        <div class="color-picker-container">
                            <div class="color-picker-label">é¢œè‰²:</div>
                            <input type="color" id="materialColor" value="#000000">
                        </div>
                        <div class="opacity-slider-container">
                            <div class="color-picker-label">é€æ˜åº¦:</div>
                            <input type="range" id="opacitySlider" class="opacity-slider" min="0" max="100" value="100">
                            <div class="opacity-value" id="opacityValue">100% (FF)</div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰è¡Œï¼šæ¸©åº¦è®¾ç½® -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="minTemp">æœ€ä½æ¸©åº¦ (Â°C):</label>
                        <input type="number" id="minTemp" min="0" max="300" value="190" placeholder="ä¾‹å¦‚: 190">
                    </div>

                    <div class="form-group">
                        <label for="maxTemp">æœ€é«˜æ¸©åº¦ (Â°C):</label>
                        <input type="number" id="maxTemp" min="0" max="300" value="230" placeholder="ä¾‹å¦‚: 230">
                    </div>

                    <div class="form-group">
                        <label for="bedTemp">çƒ­åºŠæ¸©åº¦ (Â°C):</label>
                        <input type="number" id="bedTemp" min="0" max="150" value="60" placeholder="ä¾‹å¦‚: 60">
                    </div>
                </div>

                <!-- ç¬¬å››è¡Œï¼šå…¶ä»–å‚æ•° -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="diameter">ç›´å¾„ (mm):</label>
                        <input type="number" id="diameter" min="0.1" max="5.0" step="0.1" value="1.75"
                            placeholder="ä¾‹å¦‚: 1.75">
                    </div>

                    <div class="form-group">
                        <label for="weight">é‡é‡ (g):</label>
                        <input type="number" id="weight" min="1" max="5000" value="1000" placeholder="ä¾‹å¦‚: 1000">
                    </div>

                    <div class="form-group">
                        <label for="productionDate">ç”Ÿäº§æ—¥æœŸ (YYMM):</label>
                        <input type="text" id="productionDate" maxlength="4" pattern="\d{4}" placeholder="ä¾‹å¦‚: 2602">
                    </div>
                </div>
            </div>

            <div class="generated-data">
                <h4>ç”Ÿæˆçš„è€—ææ•°æ®æ ¼å¼:</h4>
                <div id="generatedFormat" class="raw-data">;ERYONE;PLA; ;000000;FF;190;230;60;175;1000;2602;</div>
                <p>æ ¼å¼è¯´æ˜: ;å‚å•†;è€—æç±»å‹;å­è€—æ;é¢œè‰²;é€æ˜åº¦;æœ€ä½æ¸©åº¦;æœ€é«˜æ¸©åº¦;çƒ­åºŠæ¸©åº¦;ç›´å¾„;é‡é‡;ç”Ÿäº§æ—¥æœŸ;</p>
            </div>

            <button id="writeBtn" disabled>ç”Ÿæˆå¹¶å†™å…¥</button>
            <button id="generateBtn">ä»…ç”Ÿæˆæ•°æ®</button>
        </div>
    </div>

    <script>
        // DOM å…ƒç´ å¼•ç”¨
        const checkNFCBtn = document.getElementById('checkNFCBtn');
        const startReadBtn = document.getElementById('startReadBtn');
        const stopReadBtn = document.getElementById('stopReadBtn');
        const writeBtn = document.getElementById('writeBtn');
        const supportInfo = document.getElementById('supportInfo');
        const statusBox = document.getElementById('statusBox');
        const statusMessage = document.getElementById('statusMessage');
        const readResult = document.getElementById('readResult');
        const parseResult = document.getElementById('parseResult');
        const dataTable = document.getElementById('dataTable');
        const rawDataText = document.getElementById('rawDataText');
        const generatedFormat = document.getElementById('generatedFormat');

        // å†™å…¥é¢æ¿çš„è¡¨å•å…ƒç´ 
        const manufacturerInput = document.getElementById('manufacturer');
        const materialTypeInput = document.getElementById('materialType');
        const subMaterialInput = document.getElementById('subMaterial');
        const materialColorInput = document.getElementById('materialColor');
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        const minTempInput = document.getElementById('minTemp');
        const maxTempInput = document.getElementById('maxTemp');
        const bedTempInput = document.getElementById('bedTemp');
        const diameterInput = document.getElementById('diameter');
        const weightInput = document.getElementById('weight');
        const productionDateInput = document.getElementById('productionDate');
        const generateBtn = document.getElementById('generateBtn');

        // å…¨å±€å˜é‡ï¼Œç”¨äºæ§åˆ¶è¯»å–è¿‡ç¨‹
        let isReading = false;
        let abortController = null; // ç”¨äºåœæ­¢è¯»å–

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯å‡½æ•°
        function updateStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusBox.className = 'status ' + type; // è®¾ç½®æ ·å¼ç±»
            statusBox.style.display = 'block';
            console.log(type.toUpperCase() + ': ' + message);
        }

        // è§£ææ•°æ®å‡½æ•°
        function parseData(text) {
            // æ¸…ç©ºä¹‹å‰çš„è§£æç»“æœ
            parseResult.style.display = 'none';
            dataTable.innerHTML = '';
            rawDataText.textContent = '';

            // æ£€æŸ¥æ˜¯å¦ç¬¦åˆè§£ææ¡ä»¶ï¼šä»¥";"å¼€å¤´ï¼Œä»¥";"ç»“å°¾
            if (text.startsWith(';') && text.endsWith(';')) {
                console.log('ç¬¦åˆè§£ææ¡ä»¶ï¼Œå¼€å§‹è§£ææ•°æ®');

                // æ˜¾ç¤ºè§£æç»“æœåŒºåŸŸ
                parseResult.style.display = 'block';

                // ä¿å­˜åŸå§‹æ•°æ®
                rawDataText.textContent = text;

                // åˆ†å‰²æ•°æ®
                const parts = text.split(';');

                // ç§»é™¤ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª(ç©º)å…ƒç´ 
                const dataParts = parts.slice(1, -1);

                // å®šä¹‰å­—æ®µåç§°
                const fieldNames = [
                    'å‚å•†',
                    'è€—æç±»å‹',
                    'å­è€—æ',
                    'é¢œè‰²',
                    'é€æ˜åº¦',
                    'æœ€ä½æ¸©åº¦',
                    'æœ€é«˜æ¸©åº¦',
                    'çƒ­åºŠæ¸©åº¦',
                    'ç›´å¾„(mm)',
                    'é‡é‡(g)',
                    'ç”Ÿäº§æ—¥æœŸ'
                ];

                // æ„å»ºè¡¨æ ¼
                let tableHTML = '';

                for (let i = 0; i < fieldNames.length && i < dataParts.length; i++) {
                    const fieldName = fieldNames[i];
                    let fieldValue = dataParts[i];

                    // ç‰¹æ®Šå¤„ç†æŸäº›å­—æ®µ
                    if (fieldName === 'å­è€—æ' && fieldValue.trim() === '') {
                        fieldValue = 'æ— ';
                    }

                    if (fieldName === 'é¢œè‰²') {
                        // å¤„ç†é¢œè‰²ï¼Œæ˜¾ç¤ºè‰²å—
                        const colorValue = fieldValue;
                        let displayValue = fieldValue;
                        let colorBlock = '';

                        if (/^[0-9A-Fa-f]{6}$/.test(fieldValue)) {
                            // å¦‚æœæ˜¯6ä½åå…­è¿›åˆ¶é¢œè‰²ä»£ç 
                            displayValue = '#' + fieldValue.toUpperCase();
                            colorBlock = `<span class="color-preview" style="background-color: #${fieldValue};"></span>`;
                        }

                        tableHTML += `
                            <tr>
                                <th>${fieldName}</th>
                                <td>${colorBlock}${displayValue}</td>
                            </tr>
                        `;
                    } else if (fieldName === 'é€æ˜åº¦') {
                        // å¤„ç†é€æ˜åº¦
                        let opacityText = fieldValue;
                        if (/^[0-9A-Fa-f]{2}$/.test(fieldValue)) {
                            const opacityDecimal = parseInt(fieldValue, 16);
                            opacityText = `${fieldValue} (${opacityDecimal}%)`;
                        }
                        tableHTML += `
                            <tr>
                                <th>${fieldName}</th>
                                <td>${opacityText}</td>
                            </tr>
                        `;
                    } else if (fieldName === 'ç”Ÿäº§æ—¥æœŸ') {
                        // å¤„ç†ç”Ÿäº§æ—¥æœŸ 2602 -> 2026å¹´02æœˆ
                        let dateText = fieldValue;
                        if (/^\d{4}$/.test(fieldValue)) {
                            const year = '20' + fieldValue.substring(0, 2);
                            const month = fieldValue.substring(2);
                            dateText = `${year}å¹´${month}æœˆ`;
                        }
                        tableHTML += `
                            <tr>
                                <th>${fieldName}</th>
                                <td>${dateText}</td>
                            </tr>
                        `;
                    } else if (fieldName === 'æœ€ä½æ¸©åº¦' || fieldName === 'æœ€é«˜æ¸©åº¦' || fieldName === 'çƒ­åºŠæ¸©åº¦') {
                        // æ¸©åº¦å­—æ®µæ·»åŠ å•ä½
                        tableHTML += `
                            <tr>
                                <th>${fieldName}</th>
                                <td>${fieldValue}Â°C</td>
                            </tr>
                        `;
                    } else if (fieldName === 'ç›´å¾„(mm)') {
                        // ç›´å¾„å­—æ®µå¤„ç†
                        let diameterText = fieldValue;
                        if (/^\d+$/.test(fieldValue)) {
                            const diameter = parseInt(fieldValue) / 100;
                            diameterText = `${diameter}mm (${fieldValue}/100)`;
                        }
                        tableHTML += `
                            <tr>
                                <th>${fieldName}</th>
                                <td>${diameterText}</td>
                            </tr>
                        `;
                    } else {
                        // æ™®é€šå­—æ®µ
                        tableHTML += `
                            <tr>
                                <th>${fieldName}</th>
                                <td>${fieldValue}</td>
                            </tr>
                        `;
                    }
                }

                dataTable.innerHTML = tableHTML;

                return {
                    success: true,
                    fields: dataParts,
                    fieldNames: fieldNames
                };
            } else {
                console.log('ä¸ç¬¦åˆè§£ææ¡ä»¶ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬');
                return {
                    success: false,
                    message: 'æ•°æ®æ ¼å¼ä¸ç¬¦åˆè§£ææ¡ä»¶'
                };
            }
        }

        // ç”Ÿæˆè€—ææ•°æ®æ ¼å¼
        function generateMaterialData() {
            // è·å–è¡¨å•å€¼
            const manufacturer = manufacturerInput.value.trim() || 'ERYONE';
            const materialType = materialTypeInput.value.trim() || 'PLA';
            let subMaterial = subMaterialInput.value.trim();

            // å­è€—æä¸ºç©ºæ—¶ä½¿ç”¨4ä¸ªç©ºæ ¼
            if (subMaterial === '') {
                subMaterial = '    ';
            }

            // é¢œè‰²å¤„ç†ï¼šä»#RRGGBBè½¬æ¢ä¸ºRRGGBB
            let color = materialColorInput.value;
            if (color.startsWith('#')) {
                color = color.substring(1).toUpperCase();
            }

            // é€æ˜åº¦å¤„ç†ï¼š0-100è½¬æ¢ä¸ºä¸¤ä½åå…­è¿›åˆ¶
            const opacityPercent = parseInt(opacitySlider.value);
            const opacityHex = Math.round(opacityPercent * 255 / 100).toString(16).toUpperCase().padStart(2, '0');

            // æ¸©åº¦å¤„ç†
            const minTemp = minTempInput.value || '190';
            const maxTemp = maxTempInput.value || '230';
            const bedTemp = bedTempInput.value || '60';

            // ç›´å¾„å¤„ç†ï¼š1.75 -> 175
            const diameter = diameterInput.value || '1.75';
            const diameterInt = Math.round(parseFloat(diameter) * 100);

            // é‡é‡å¤„ç†
            const weight = weightInput.value || '1000';

            // ç”Ÿäº§æ—¥æœŸå¤„ç†
            const productionDate = productionDateInput.value || '2602';

            // ç”Ÿæˆæ ¼å¼å­—ç¬¦ä¸²
            const materialData = `;${manufacturer};${materialType};${subMaterial};${color};${opacityHex};${minTemp};${maxTemp};${bedTemp};${diameterInt};${weight};${productionDate};`;

            return materialData;
        }

        // æ›´æ–°ç”Ÿæˆçš„æ•°æ®æ˜¾ç¤º
        function updateGeneratedData() {
            const materialData = generateMaterialData();
            generatedFormat.textContent = materialData;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–ï¼Œå®æ—¶æ›´æ–°ç”Ÿæˆçš„æ•°æ®
            const inputs = [
                manufacturerInput, materialTypeInput, subMaterialInput, materialColorInput,
                opacitySlider, minTempInput, maxTempInput, bedTempInput,
                diameterInput, weightInput, productionDateInput
            ];

            inputs.forEach(input => {
                input.addEventListener('input', updateGeneratedData);
            });

            // é€æ˜åº¦æ»‘å—æ˜¾ç¤º
            opacitySlider.addEventListener('input', function () {
                const value = this.value;
                const hexValue = Math.round(value * 255 / 100).toString(16).toUpperCase().padStart(2, '0');
                opacityValue.textContent = `${value}% (${hexValue})`;
                updateGeneratedData();
            });

            // ä»…ç”Ÿæˆæ•°æ®æŒ‰é’®
            generateBtn.addEventListener('click', function () {
                updateGeneratedData();
                updateStatus('æ•°æ®å·²ç”Ÿæˆï¼Œå¯å¤åˆ¶ä½¿ç”¨æˆ–å†™å…¥æ ‡ç­¾ã€‚', 'info');
            });

            // è®¾ç½®ç”Ÿäº§æ—¥æœŸé»˜è®¤å€¼ä¸ºå½“å‰å¹´æœˆ
            const now = new Date();
            const currentYear = now.getFullYear().toString().substring(2);
            const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            if (!productionDateInput.value) {
                productionDateInput.value = currentYear + currentMonth;
                updateGeneratedData();
            }
        }

        // 1. æ£€æŸ¥NFCæ”¯æŒä¸æƒé™ (å®‰å…¨åˆå§‹åŒ–ç‰ˆ)
        checkNFCBtn.addEventListener('click', async function () {
            readResult.textContent = '';
            let detailedLog = '=== Web NFC ç¯å¢ƒè¯Šæ–­æŠ¥å‘Š ===\n\n';
            updateStatus('æ­£åœ¨æ£€æµ‹NFCæ”¯æŒ...', 'info');

            // ç¬¬ä¸€æ­¥ï¼šå®‰å…¨åœ°æ¢æµ‹å…¨å±€å¯¹è±¡ä¸­å¯èƒ½å­˜åœ¨çš„NFCç›¸å…³API
            detailedLog += '1. æ¢æµ‹å…¨å±€NFCå¯¹è±¡...\n';
            const globalObjectsToCheck = [
                'navigator.nfc',
                'window.NDEFReader',
                'navigator.ndef',
                'window.nfc',
                'NDEFReader' // ç›´æ¥æ£€æŸ¥æ„é€ å‡½æ•°
            ];

            let foundApiPath = null;
            let foundApiObject = null;

            for (const objPath of globalObjectsToCheck) {
                try {
                    // ä½¿ç”¨evalå®‰å…¨åœ°è®¿é—®å¯èƒ½çš„å¤šçº§å±æ€§ (ä»…ç”¨äºè¯Šæ–­)
                    const value = eval(objPath);
                    if (value) {
                        foundApiPath = objPath;
                        foundApiObject = value;
                        detailedLog += `   âœ… å‘ç°: ${objPath}\n`;
                        break; // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå°±åœæ­¢
                    }
                } catch (e) {
                    // å¿½ç•¥è®¿é—®é”™è¯¯
                }
            }

            if (!foundApiPath) {
                detailedLog += '   âŒ æœªåœ¨å…¨å±€å¯¹è±¡ä¸­æ‰¾åˆ°NFC APIã€‚\n';
                detailedLog += '\n2. å»ºè®®ï¼š\n';
                detailedLog += '   a) ç¡®ä¿ä½¿ç”¨Android Chrome/Edgeæœ€æ–°ç‰ˆ\n';
                detailedLog += '   b) åœ¨chrome://flagsä¸­æœç´¢å¹¶å¯ç”¨"WebNFC"\n';
                updateStatus('âŒ æœªæ‰¾åˆ°NFC APIå¯¹è±¡', 'error');
                readResult.textContent = detailedLog;
                return;
            }

            detailedLog += `\n2. ä½¿ç”¨æ‰¾åˆ°çš„APIè·¯å¾„: ${foundApiPath}\n`;

            // ç¬¬äºŒæ­¥ï¼šæ ¹æ®æ‰¾åˆ°çš„APIè·¯å¾„ï¼Œé‡‡ç”¨ä¸åŒçš„è°ƒç”¨ç­–ç•¥
            detailedLog += '\n3. å°è¯•åˆå§‹åŒ–ä¸è¯·æ±‚æƒé™...\n';
            updateStatus('æ­£åœ¨åˆå§‹åŒ–NFCå¹¶è¯·æ±‚æƒé™...', 'info');

            try {
                let ndefReader;

                // ç­–ç•¥Aï¼šå¦‚æœæ‰¾åˆ°çš„æ˜¯ NDEFReader æ„é€ å‡½æ•°
                if (foundApiPath === 'window.NDEFReader' || foundApiPath === 'NDEFReader') {
                    ndefReader = new NDEFReader();
                    detailedLog += '   æ–¹å¼: ä½¿ç”¨ new NDEFReader()\n';
                }
                // ç­–ç•¥Bï¼šå¦‚æœæ‰¾åˆ°çš„æ˜¯ navigator.nfc å¯¹è±¡
                else if (foundApiPath === 'navigator.nfc') {
                    // æ³¨æ„ï¼šæ ¹æ®Web NFCæ ‡å‡†ï¼Œnavigator.nfc ä¸‹æ²¡æœ‰ç›´æ¥çš„scanæ–¹æ³•
                    // å®ƒåº”è¯¥é€šè¿‡ NDEFReader ä½¿ç”¨ï¼Œä½†æŸäº›å®ç°å¯èƒ½ä¸åŒ
                    detailedLog += '   æ–¹å¼: å°è¯•é€šè¿‡ navigator.nfc è®¿é—®\n';

                    // å…ˆå°è¯•æ ‡å‡†æ–¹å¼
                    if (window.NDEFReader) {
                        ndefReader = new NDEFReader();
                        detailedLog += '   -> å›é€€åˆ°æ ‡å‡† NDEFReader\n';
                    } else {
                        // å¦‚æœæµè§ˆå™¨éæ ‡å‡†ï¼Œå°è¯•ç›´æ¥è°ƒç”¨
                        throw new Error('éæ ‡å‡†navigator.nfcå®ç°ï¼Œéœ€è¦ç‰¹å®šè°ƒç”¨æ–¹å¼');
                    }
                }
                // ç­–ç•¥Cï¼šå…¶ä»–å‘ç°çš„å¯¹è±¡
                else {
                    detailedLog += `   æ–¹å¼: å°è¯•ç›´æ¥ä½¿ç”¨ ${foundApiPath}\n`;
                    // å¯¹äºä¸ç¡®å®šçš„å¯¹è±¡ï¼Œå°è¯•é€šç”¨çš„scanè°ƒç”¨
                    if (typeof foundApiObject.scan === 'function') {
                        // å¦‚æœå¯¹è±¡æœ¬èº«æœ‰scanæ–¹æ³•ï¼Œç›´æ¥ä½¿ç”¨
                        await foundApiObject.scan();
                        detailedLog += '   âœ… æƒé™è¯·æ±‚å·²å‘é€ï¼ˆéæ ‡å‡†APIï¼‰\n';

                        // å¦‚æœæˆåŠŸï¼Œæˆ‘ä»¬å‡è®¾æƒé™å·²è·å¾—
                        updateStatus('âœ… éæ ‡å‡†APIå°±ç»ªï¼Œè¯·å°è¯•è¯»å†™æ“ä½œ', 'info');
                        startReadBtn.disabled = false;
                        writeBtn.disabled = false;
                        checkNFCBtn.disabled = true;
                        checkNFCBtn.textContent = 'APIå°±ç»ª';
                        readResult.textContent = detailedLog;
                        return;
                    } else {
                        throw new Error(`æ‰¾åˆ°çš„å¯¹è±¡ ${foundApiPath} æ²¡æœ‰ .scan() æ–¹æ³•`);
                    }
                }

                // å¯¹äºæ ‡å‡†çš„ NDEFReader å®ä¾‹ï¼Œè¿›è¡Œæ‰«æ
                if (ndefReader && typeof ndefReader.scan === 'function') {
                    // è®¾ç½®ä¸€ä¸ªè¶…æ—¶ï¼Œé˜²æ­¢æƒé™è¯·æ±‚å¡ä½
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('æƒé™è¯·æ±‚è¶…æ—¶(10ç§’)')), 10000);
                    });

                    await Promise.race([
                        ndefReader.scan(),
                        timeoutPromise
                    ]);

                    detailedLog += '   âœ… NDEFReader.scan() è°ƒç”¨æˆåŠŸ\n';
                    detailedLog += '   âœ… NFCæƒé™åº”å·²è·å¾—\n\n';
                    detailedLog += 'âœ¨ åˆå§‹åŒ–æˆåŠŸï¼ç°åœ¨å¯ä»¥ï¼š\n';
                    detailedLog += '   â€¢ ç‚¹å‡»"å¼€å§‹è¯»å–"è¯»å–æ ‡ç­¾\n';
                    detailedLog += '   â€¢ è¾“å…¥æ–‡æœ¬åç‚¹å‡»"å†™å…¥æ•°æ®"å†™å…¥æ ‡ç­¾\n';

                    // ä¿å­˜readerå®ä¾‹ä¾›åç»­ä½¿ç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    window._ndefReader = ndefReader;

                    updateStatus('âœ… NFCåŠŸèƒ½å·²å°±ç»ªï¼', 'success');
                    startReadBtn.disabled = false;
                    writeBtn.disabled = false;
                    checkNFCBtn.disabled = true;
                    checkNFCBtn.textContent = 'å·²å°±ç»ª';
                    supportInfo.innerHTML = '<strong>âœ… Web NFC åˆå§‹åŒ–æˆåŠŸ</strong>';

                } else {
                    throw new Error('NDEFReaderå®ä¾‹æˆ–.scan()æ–¹æ³•ä¸å¯ç”¨');
                }

                readResult.textContent = detailedLog;

            } catch (error) {
                detailedLog += `   âŒ åˆå§‹åŒ–å¤±è´¥:\n`;
                detailedLog += `      é”™è¯¯: ${error.name}\n`;
                detailedLog += `      ä¿¡æ¯: ${error.message}\n\n`;

                if (error.name === 'NotAllowedError') {
                    detailedLog += '   ğŸ’¡ æ‚¨æ‹’ç»äº†æƒé™è¯·æ±‚ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚\n';
                    updateStatus('âŒ æƒé™è¢«æ‹’ç»', 'error');
                } else if (error.name === 'NotSupportedError') {
                    detailedLog += '   ğŸ’¡ æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒNDEFæ ‡ç­¾æ‰«æã€‚\n';
                    updateStatus('âŒ è®¾å¤‡ä¸æ”¯æŒ', 'error');
                } else if (error.message.includes('è¶…æ—¶')) {
                    detailedLog += '   ğŸ’¡ æƒé™è¯·æ±‚è¶…æ—¶ã€‚å¯èƒ½æ˜¯ï¼š\n';
                    detailedLog += '       1. æƒé™å¼¹çª—è¢«å…¶ä»–ç•Œé¢é®æŒ¡\n';
                    detailedLog += '       2. æµè§ˆå™¨æœªæ­£ç¡®è§¦å‘æƒé™è¯·æ±‚\n';
                    detailedLog += '       3. å°è¯•é‡å¯æµè§ˆå™¨\n';
                    updateStatus('â±ï¸ è¯·æ±‚è¶…æ—¶', 'info');
                } else {
                    detailedLog += '   ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š\n';
                    detailedLog += '       1. APIè°ƒç”¨æ–¹å¼ä¸åŒ¹é…æ‚¨çš„æµè§ˆå™¨\n';
                    detailedLog += '       2. å°è¯•åœ¨chrome://flagså¯ç”¨"Experimental Web Platform features"\n';

                    // ç‰¹æ®Šå»ºè®®ï¼šå¦‚æœå…¶ä»–ç½‘ç«™èƒ½ç”¨ï¼Œå°è¯•ç›´æ¥è°ƒç”¨ä»–ä»¬çš„æ–¹å¼
                    detailedLog += '\n   ğŸ” ç”±äºæ‚¨åœ¨webnfc.orgå¯ç”¨ï¼Œè¯·å°è¯•ï¼š\n';
                    detailedLog += '       æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·(F12)â†’æ§åˆ¶å°(Console)\n';
                    detailedLog += '       è¾“å…¥: NDEFReader å¹¶å›è½¦ï¼ŒæŸ¥çœ‹æ˜¯å¦å®šä¹‰\n';
                    detailedLog += '       è¾“å…¥: navigator.nfc å¹¶å›è½¦ï¼ŒæŸ¥çœ‹æ˜¯å¦å®šä¹‰\n';

                    updateStatus('âš ï¸ åˆå§‹åŒ–é”™è¯¯ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…', 'error');
                }

                readResult.textContent = detailedLog;
            }
        });

        // 2. å¼€å§‹è¯»å–æ ‡ç­¾ (é‡æ„ç‰ˆ - æ›´è´´è¿‘è§„èŒƒå®ç°)
        startReadBtn.addEventListener('click', async () => {
            isReading = true;
            startReadBtn.disabled = true;
            stopReadBtn.disabled = false;
            readResult.innerHTML = 'è¯·å°†NFCæ ‡ç­¾è´´è¿‘æ‰‹æœºèƒŒé¢...<br>(ç¡®ä¿æ ‡ç­¾åœ¨NFCæ„Ÿåº”åŒºå†…åœç•™ç‰‡åˆ»)';
            parseResult.style.display = 'none'; // éšè—ä¹‹å‰çš„è§£æç»“æœ
            updateStatus('æ­£åœ¨å¯åŠ¨æ‰«æï¼Œè¯·é è¿‘æ ‡ç­¾...', 'info');

            abortController = new AbortController();

            try {
                // ä½¿ç”¨æ›´æ ‡å‡†çš„ NDEFReader è°ƒç”¨æ–¹å¼
                const ndefReader = new NDEFReader();

                // æ–¹æ¡ˆA: ä½¿ç”¨æ›´æ˜ç¡®çš„ promise å’Œ event listener ç»„åˆ
                // è¿™æ˜¯è®¸å¤šèƒ½å·¥ä½œçš„ç«™ç‚¹é‡‡ç”¨çš„æ¨¡å¼
                console.log('å¼€å§‹æ‰«æ...');

                // å…ˆæ·»åŠ è¯»å–äº‹ä»¶ç›‘å¬å™¨
                ndefReader.addEventListener('reading', ({ message, serialNumber }) => {
                    console.log('âœ… æ£€æµ‹åˆ° reading äº‹ä»¶ï¼');
                    updateStatus('âœ… æ£€æµ‹åˆ°æ ‡ç­¾ï¼', 'success');

                    // æ„å»ºæ˜¾ç¤ºç»“æœ
                    let resultText = `=== NFCæ ‡ç­¾è¯»å–æˆåŠŸ ===\n`;
                    resultText += `æ—¶é—´: ${new Date().toLocaleTimeString()}\n`;
                    resultText += `åºåˆ—å·: ${serialNumber || 'æœªæä¾›'}\n`;
                    resultText += `è®°å½•æ•°: ${message.records.length}\n\n`;

                    const textDecoder = new TextDecoder();
                    message.records.forEach((record, index) => {
                        resultText += `[è®°å½• #${index + 1}]\n`;
                        resultText += `  ç±»å‹: ${record.recordType}\n`;

                        try {
                            if (record.recordType === 'text') {
                                const text = textDecoder.decode(record.data);
                                resultText += `  å†…å®¹: ${text}\n`;

                                // å°è¯•è§£ææ•°æ®
                                const parseResult = parseData(text);
                                if (!parseResult.success) {
                                    resultText += `  è¯´æ˜: æ ¼å¼ä¸ç¬¦åˆè§£ææ¡ä»¶\n`;
                                }

                                if (record.lang) resultText += `  è¯­è¨€: ${record.lang}\n`;
                            } else if (record.recordType === 'url') {
                                const url = textDecoder.decode(record.data);
                                resultText += `  URL: ${url}\n`;
                            } else if (record.recordType === 'mime' && record.mediaType) {
                                resultText += `  MIMEç±»å‹: ${record.mediaType}\n`;
                                resultText += `  æ•°æ®å¤§å°: ${record.data.byteLength} å­—èŠ‚\n`;
                            } else {
                                resultText += `  æ•°æ®: ${textDecoder.decode(record.data)}\n`;
                            }
                        } catch (e) {
                            resultText += `  æ•°æ®è§£ç å¤±è´¥\n`;
                        }
                        resultText += '\n';
                    });

                    readResult.textContent = resultText;

                    // å•æ¬¡è¯»å–åè‡ªåŠ¨åœæ­¢
                    if (abortController) {
                        abortController.abort();
                        isReading = false;
                        startReadBtn.disabled = false;
                        stopReadBtn.disabled = true;
                        updateStatus('è¯»å–å®Œæˆï¼Œå¯å†æ¬¡è¯»å–ã€‚', 'success');
                    }
                });

                // æ·»åŠ é”™è¯¯äº‹ä»¶ç›‘å¬å™¨
                ndefReader.addEventListener('readingerror', () => {
                    console.log('âŒ è¯»å–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
                    updateStatus('æ ‡ç­¾è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚', 'error');
                    readResult.innerHTML += '\n\nâŒ è¯»å–å¤±è´¥ï¼Œè¯·ç¡®ä¿æ ‡ç­¾ç±»å‹æ­£ç¡®ä¸”å¯è¯»ã€‚';
                });

                // æœ€åå¯åŠ¨æ‰«æï¼Œä¼ å…¥ç»ˆæ­¢ä¿¡å·
                await ndefReader.scan({ signal: abortController.signal });

                updateStatus('âœ… æ‰«æå·²å¯åŠ¨ï¼Œè¯·é è¿‘æ ‡ç­¾...', 'info');
                readResult.innerHTML += '\n\nâœ… æ‰«æå™¨å·²æ¿€æ´»ï¼Œç­‰å¾…æ ‡ç­¾...';

                // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢æ— é™ç­‰å¾…
                setTimeout(() => {
                    if (isReading) {
                        updateStatus('âš ï¸ æœªæ£€æµ‹åˆ°æ ‡ç­¾ï¼Œè¯·ç¡®ä¿æ ‡ç­¾åœ¨æ„Ÿåº”åŒºå†…', 'info');
                        readResult.innerHTML += '<br><br>â±ï¸ ç­‰å¾…è¶…æ—¶ï¼Œæœªæ£€æµ‹åˆ°æ ‡ç­¾ã€‚<br>å¯èƒ½åŸå› ï¼š<br>1. æ ‡ç­¾æœªè´´è¿‘æ„Ÿåº”åŒº<br>2. æ ‡ç­¾ç±»å‹ä¸å—æ”¯æŒ<br>3. æ ‡ç­¾å·²æŸåæˆ–æ— æ•°æ®';
                    }
                }, 15000); // 15ç§’åæç¤º

            } catch (error) {
                console.error('æ‰«æå¯åŠ¨å¤±è´¥:', error);

                if (error.name === 'AbortError') {
                    updateStatus('è¯»å–å·²åœæ­¢ã€‚', 'info');
                } else if (error.name === 'NotAllowedError') {
                    updateStatus('âŒ æ— NFCæƒé™ï¼Œè¯·å…ˆæˆæƒã€‚', 'error');
                    readResult.textContent = 'é”™è¯¯: NFCæƒé™æœªè·å¾—ã€‚\nè¯·å…ˆç‚¹å‡»"æ£€æŸ¥NFCæ”¯æŒä¸æƒé™"æŒ‰é’®å®Œæˆæˆæƒã€‚';
                } else if (error.name === 'NotSupportedError') {
                    updateStatus('âŒ è®¾å¤‡ä¸æ”¯æŒNDEFæ‰«æã€‚', 'error');
                    readResult.textContent = `é”™è¯¯: ${error.message}\n\næ‚¨çš„è®¾å¤‡å¯èƒ½ä¸æ”¯æŒæ­¤ç±»å‹çš„NFCæ ‡ç­¾è¯»å†™ã€‚`;
                } else {
                    updateStatus(`âŒ æ‰«æå¤±è´¥: ${error.message}`, 'error');
                    readResult.textContent = `é”™è¯¯è¯¦æƒ…:\nåç§°: ${error.name}\nä¿¡æ¯: ${error.message}\n\nè¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚`;
                }

                isReading = false;
                startReadBtn.disabled = false;
                stopReadBtn.disabled = true;
            }
        });

        // 3. åœæ­¢è¯»å–æ ‡ç­¾
        stopReadBtn.addEventListener('click', () => {
            if (abortController) {
                abortController.abort();
            }
            isReading = false;
            startReadBtn.disabled = false;
            stopReadBtn.disabled = true;
            updateStatus('è¯»å–å·²æ‰‹åŠ¨åœæ­¢ã€‚', 'info');
        });

        // 4. å†™å…¥æ•°æ®åˆ°æ ‡ç­¾
        writeBtn.addEventListener('click', async () => {
            const materialData = generateMaterialData();

            if (!materialData) {
                updateStatus('âŒ è¯·å…ˆå¡«å†™å®Œæ•´çš„è€—æä¿¡æ¯ã€‚', 'error');
                return;
            }

            updateStatus('è¯·å°†è¦å†™å…¥çš„æ ‡ç­¾è´´è¿‘æ‰‹æœºèƒŒé¢...', 'info');

            try {
                // è°ƒç”¨å†™å…¥API
                const ndefWriter = new NDEFReader();
                await ndefWriter.write({
                    records: [{
                        recordType: "text",
                        data: materialData,
                        lang: "en"
                    }]
                });
                updateStatus(`âœ… è€—ææ•°æ®å†™å…¥æˆåŠŸï¼`, 'success');
                updateStatus(`å†™å…¥å†…å®¹: ${materialData}`, 'info');
            } catch (error) {
                updateStatus(`âŒ å†™å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function () {
            initEventListeners();
            updateGeneratedData(); // åˆå§‹ç”Ÿæˆä¸€æ¬¡æ•°æ®
        });
    </script>
</body>

</html>